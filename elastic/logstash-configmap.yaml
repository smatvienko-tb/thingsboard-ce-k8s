apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-configmap
data:
  logstash.yml: |
    http.host: "0.0.0.0"
    path.config: /usr/share/logstash/pipeline
    config.reload.automatic: true
    config.reload.interval: 3s
  logstash.conf: |
    # all input will come from filebeat, no local logs
    input {
      beats {
        port => 5044
      }
    }
    filter {
      grok {
        match => { "message" => "%{TIMESTAMP_ISO8601:[@metadata][timestamp]} \[%{DATA:thread}\] %{DATA:level}%{SPACE} %{DATA:class} - %{GREEDYDATA:message}" }
        overwrite => ["message"]
      }
      date {
        match => [ "[@metadata][timestamp]", "ISO8601" ]
      }
    }
    filter {
        grok {
          match => { "[log][file][path]" => "/var/log/containers/%{DATA:k8s.pod}_%{DATA:k8s.namespace}_%{DATA:k8s.id}\.log" }
        }
    }
    output {
    stdout {}
      elasticsearch {
        index => "logstash-%{[@metadata][beat]}"
        hosts => [ "${ES_HOSTS}" ]
        user => "${ES_USER}"
        password => "${ES_PASSWORD}"
        cacert => '/etc/logstash/certificates/ca.crt'
      }
    }